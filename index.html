<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UGCET College Counselling 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 100%;
            padding: 1rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            margin: -1rem -1rem 1rem -1rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .login-screen {
            max-width: 400px;
            margin: 2rem auto;
        }

        .tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 10px;
        }

        .tab {
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border);
            background: var(--surface);
            color: var(--text);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            width: auto;
            font-size: 0.875rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .checkbox-label:active {
            transform: scale(0.98);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"]:checked + span {
            color: var(--primary);
            font-weight: 600;
        }

        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .user-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .user-email {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .results-count {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .filters {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            background: var(--surface);
            color: var(--text);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
        }

        .table-container {
            background: var(--surface);
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-weight: 700;
            background: var(--bg);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .college-code {
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
        }

        .cutoff-rank {
            font-weight: 600;
            color: var(--success);
        }

        .college-name {
            font-size: 0.8rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .branch-name {
            font-size: 0.8rem;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary);
            color: white;
            padding: 0.75rem;
            text-align: center;
            z-index: 1000;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
            
            .header {
                margin: -2rem -2rem 2rem -2rem;
                padding: 2rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .checkbox-group {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="loadingIndicator" class="loading-indicator hidden">
        ‚è≥ Loading college data... Please wait...
    </div>

    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="card">
                <h2>üéì UGCET Counselling 2025</h2>
                <p style="text-align: center; margin-bottom: 1.5rem; color: var(--text-muted);">Find your perfect engineering college</p>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('login')">Login</button>
                    <button class="tab" onclick="switchTab('signup')">Sign Up</button>
                </div>

                <div id="errorMessage" class="error hidden"></div>
                <div id="successMessage" class="success hidden"></div>

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>

                <!-- Signup Form -->
                <form id="signupForm" class="hidden">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" required placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required placeholder="Choose a password">
                    </div>
                    <button type="submit" class="btn">Create Account</button>
                </form>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="header">
                <h1>üéì UGCET Counselling 2025</h1>
                <p>Find your perfect engineering college</p>
            </div>

            <div class="user-bar">
                <div>
                    <div class="user-name" id="userName"></div>
                    <div class="user-email" id="userEmail"></div>
                </div>
                <button class="btn btn-small btn-secondary" onclick="logout()">Logout</button>
            </div>

            <!-- Preferences Form -->
            <div class="card">
                <h2>üìù Your Preferences</h2>
                <form id="preferencesForm">
                    <div class="form-group">
                        <label for="studentRank">Your UGCET Rank *</label>
                        <input type="number" id="studentRank" required placeholder="Enter your rank">
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" required>
                            <option value="">Select Category</option>
                            <option value="GM">General Merit (GM)</option>
                            <option value="1G">Category 1 (SC, ST)</option>
                            <option value="2AG">Category 2A</option>
                            <option value="2BG">Category 2B</option>
                            <option value="3AG">Category 3A</option>
                            <option value="3BG">Category 3B</option>
                            <option value="SCG">SC Category</option>
                            <option value="STG">ST Category</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Preferred Locations</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="location" value="Bangalore">
                                <span>Bangalore</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="location" value="Mysore">
                                <span>Mysore</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="location" value="Mangalore">
                                <span>Mangalore</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="location" value="Belgaum">
                                <span>Belgaum</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="location" value="Hubli">
                                <span>Hubli</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="location" value="Manipal">
                                <span>Manipal</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="location" value="All">
                                <span>All Locations</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Preferred Branches</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="COMPUTER SCIENCE">
                                <span>CS</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="INFORMATION SCIENCE">
                                <span>IS</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="ELECTRONICS">
                                <span>EC</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="ELECTRICAL">
                                <span>EE</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="MECHANICAL">
                                <span>Mech</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="CIVIL">
                                <span>Civil</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="ARTIFICIAL INTELLIGENCE">
                                <span>AI/ML</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="DATA SCIENCE">
                                <span>Data Sci</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="All">
                                <span>All Branches</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Special Reservations</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="reservation" value="K">
                                <span>Kannada (K)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="reservation" value="R">
                                <span>Rural (R)</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn">üîç Find Colleges</button>
                </form>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <div class="card">
                    <div class="results-header">
                        <div class="results-count" id="resultsCount">0 colleges found</div>
                        <button class="btn btn-small btn-success" onclick="downloadResults()">
                            ‚¨á Download CSV
                        </button>
                    </div>

                    <div class="filters">
                        <input type="text" class="filter-input" id="searchCollege" placeholder="üîç Search college..." onkeyup="filterResults()">
                        <input type="text" class="filter-input" id="searchBranch" placeholder="üîç Search branch..." onkeyup="filterResults()">
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Code</th>
                                    <th>College</th>
                                    <th>Branch</th>
                                    <th>R1</th>
                                    <th>R2</th>
                                    <th>R3</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr>
                                    <td colspan="7" class="loading">Enter your preferences to see results</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let collegeData = [];
        let currentUser = null;
        let filteredResults = [];
        let allResults = [];
        let dataLoaded = false;

        window.addEventListener('load', async () => {
            checkLogin();
            await loadData();
        });

        async function loadData() {
            const indicator = document.getElementById('loadingIndicator');
            indicator.classList.remove('hidden');
            
            try {
                console.log('üì• Loading data...');
                const response = await fetch('data.json');
                if (!response.ok) throw new Error('Failed to load');
                
                const compactData = await response.json();
                console.log(`üì¶ Received ${compactData.length} records`);
                
                // Unpack compact format
                collegeData = compactData.map(row => {
                    const unpacked = {
                        'College Code': row.c,
                        'College Name': row.n,
                        'Branch Name': row.b,
                        'Category': row.t
                    };
                    
                    // Unpack ranks array
                    const cat = row.t;
                    const rankKeys = [
                        `${cat}_R1`, `${cat}K_R1`, `${cat}R_R1`,
                        `${cat}_R2`, `${cat}K_R2`, `${cat}R_R2`,
                        `${cat}_R3`, `${cat}K_R3`, `${cat}R_R3`
                    ];
                    
                    row.r.forEach((rank, i) => {
                        if (i < rankKeys.length) {
                            unpacked[rankKeys[i]] = rank;
                        }
                    });
                    
                    return unpacked;
                });
                
                dataLoaded = true;
                indicator.classList.add('hidden');
                console.log(`‚úÖ Ready! ${collegeData.length} colleges loaded`);
                showSuccess('Data loaded successfully! You can now search for colleges.');
            } catch (error) {
                indicator.classList.add('hidden');
                console.error('‚ùå Error:', error);
                alert('Failed to load data. Please check your connection and refresh.');
                dataLoaded = false;
            }
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
                tabs[1].classList.add('active');
            }
            hideError();
            hideSuccess();
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const userKey = `user_${email}`;
                const userData = localStorage.getItem(userKey);
                
                if (!userData) {
                    showError('Account not found. Please sign up first.');
                    return;
                }

                const user = JSON.parse(userData);
                if (user.password !== password) {
                    showError('Incorrect password. Please try again.');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showDashboard();
            } catch (error) {
                showError('Login failed. Please try again.');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;

            try {
                const userKey = `user_${email}`;
                const existingUser = localStorage.getItem(userKey);
                
                if (existingUser) {
                    showError('Account already exists. Please login instead.');
                    return;
                }

                const userData = {
                    email,
                    password,
                    name,
                    createdAt: new Date().toISOString()
                };

                localStorage.setItem(userKey, JSON.stringify(userData));
                
                currentUser = userData;
                localStorage.setItem('currentUser', JSON.stringify(userData));
                showSuccess('Account created successfully!');
                setTimeout(() => showDashboard(), 1000);
            } catch (error) {
                showError('Signup failed. Please try again.');
            }
        });

        document.getElementById('preferencesForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!dataLoaded) {
                alert('Data is still loading. Please wait...');
                return;
            }
            findColleges();
        });

        function findColleges() {
            const rank = parseInt(document.getElementById('studentRank').value);
            const category = document.getElementById('category').value;
            const locations = Array.from(document.querySelectorAll('input[name="location"]:checked')).map(cb => cb.value);
            const branches = Array.from(document.querySelectorAll('input[name="branch"]:checked')).map(cb => cb.value);
            const reservations = Array.from(document.querySelectorAll('input[name="reservation"]:checked')).map(cb => cb.value);

            if (!rank || !category) {
                alert('Please enter your rank and select category');
                return;
            }

            let results = collegeData.filter(row => {
                if (row.Category !== category) return false;

                const includeAllLocations = locations.includes('All');
                if (!includeAllLocations && locations.length > 0) {
                    const matchesLocation = locations.some(loc => 
                        row['College Name'] && row['College Name'].toUpperCase().includes(loc.toUpperCase())
                    );
                    if (!matchesLocation) return false;
                }

                const includeAllBranches = branches.includes('All');
                if (!includeAllBranches && branches.length > 0) {
                    const matchesBranch = branches.some(br => 
                        row['Branch Name'] && row['Branch Name'].toUpperCase().includes(br.toUpperCase())
                    );
                    if (!matchesBranch) return false;
                }

                let cutoffColumns = [];
                if (reservations.includes('K')) {
                    cutoffColumns = [`${category}K_R1`, `${category}K_R2`, `${category}K_R3`];
                } else if (reservations.includes('R')) {
                    cutoffColumns = [`${category}R_R1`, `${category}R_R2`, `${category}R_R3`];
                } else {
                    cutoffColumns = [`${category}_R1`, `${category}_R2`, `${category}_R3`];
                }

                const qualifies = cutoffColumns.some(col => {
                    const cutoff = row[col];
                    return cutoff && rank <= cutoff;
                });

                return qualifies;
            });

            results.sort((a, b) => {
                const getCutoff = (row) => {
                    let cols = [];
                    if (reservations.includes('K')) {
                        cols = [`${category}K_R3`, `${category}K_R2`, `${category}K_R1`];
                    } else if (reservations.includes('R')) {
                        cols = [`${category}R_R3`, `${category}R_R2`, `${category}R_R1`];
                    } else {
                        cols = [`${category}_R3`, `${category}_R2`, `${category}_R1`];
                    }
                    for (let col of cols) {
                        const val = row[col];
                        if (val) return val;
                    }
                    return Infinity;
                };
                return getCutoff(a) - getCutoff(b);
            });

            allResults = results;
            filteredResults = results;
            displayResults(results);
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            const resultsSection = document.getElementById('resultsSection');
            const resultsCount = document.getElementById('resultsCount');

            resultsSection.classList.remove('hidden');
            resultsCount.textContent = `${results.length} college${results.length !== 1 ? 's' : ''} found`;

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">No colleges found matching your criteria</td></tr>';
                return;
            }

            const category = document.getElementById('category').value;
            const reservations = Array.from(document.querySelectorAll('input[name="reservation"]:checked')).map(cb => cb.value);
            
            let prefix = category;
            if (reservations.includes('K')) prefix += 'K';
            else if (reservations.includes('R')) prefix += 'R';

            tbody.innerHTML = results.map((row, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td class="college-code">${row['College Code'] || '-'}</td>
                    <td class="college-name" title="${row['College Name'] || ''}">${row['College Name'] || '-'}</td>
                    <td class="branch-name" title="${row['Branch Name'] || ''}">${row['Branch Name'] || '-'}</td>
                    <td class="cutoff-rank">${row[`${prefix}_R1`] || '-'}</td>
                    <td class="cutoff-rank">${row[`${prefix}_R2`] || '-'}</td>
                    <td class="cutoff-rank">${row[`${prefix}_R3`] || '-'}</td>
                </tr>
            `).join('');
        }

        function filterResults() {
            const searchCollege = document.getElementById('searchCollege').value.toLowerCase();
            const searchBranch = document.getElementById('searchBranch').value.toLowerCase();

            let filtered = allResults.filter(row => {
                const collegeName = (row['College Name'] || '').toLowerCase();
                const branchName = (row['Branch Name'] || '').toLowerCase();
                
                if (searchCollege && !collegeName.includes(searchCollege)) return false;
                if (searchBranch && !branchName.includes(searchBranch)) return false;
                
                return true;
            });

            filteredResults = filtered;
            displayResults(filtered);
        }

        function downloadResults() {
            if (filteredResults.length === 0) {
                alert('No results to download');
                return;
            }

            const category = document.getElementById('category').value;
            const reservations = Array.from(document.querySelectorAll('input[name="reservation"]:checked')).map(cb => cb.value);
            let prefix = category;
            if (reservations.includes('K')) prefix += 'K';
            else if (reservations.includes('R')) prefix += 'R';

            const headers = ['S.No', 'College Code', 'College Name', 'Branch', 'Round 1', 'Round 2', 'Round 3'];
            const csvContent = [
                headers.join(','),
                ...filteredResults.map((row, idx) => {
                    const escapeCsv = (str) => {
                        if (!str) return '';
                        str = String(str);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    };
                    
                    return [
                        idx + 1,
                        escapeCsv(row['College Code']),
                        escapeCsv(row['College Name']),
                        escapeCsv(row['Branch Name']),
                        escapeCsv(row[`${prefix}_R1`] || '-'),
                        escapeCsv(row[`${prefix}_R2`] || '-'),
                        escapeCsv(row[`${prefix}_R3`] || '-')
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `UGCET_Results_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function checkLogin() {
            const stored = localStorage.getItem('currentUser');
            if (stored) {
                currentUser = JSON.parse(stored);
                showDashboard();
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('signupForm').reset();
            document.getElementById('preferencesForm').reset();
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }

        function hideSuccess() {
            document.getElementById('successMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
